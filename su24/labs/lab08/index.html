<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="language" content="english">
<title>Lab 8 | CS 61C Summer 2024</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">
<link rel="shortcut icon" type="image/png" href="../../img/favicon.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" integrity="sha512-GQGU0fMMi238uA+a/bdWJfpUGKUkBdgfFdgBm72SUQ6BeyWjoY/ton0tEjH+OSH9iP4Dfh+7HM0I9f5eR0L/4w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.min.js" integrity="sha512-OvBgP9A2JBgiRad/mM36mkzXSXaJE9BEIENnVEmeZdITvwT09xnxLtT4twkCa8m/loMbPHsvPl0T8lRGVBwjlQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js" integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin="anonymous"></script>
<link rel="stylesheet" href="../../css/main.css@h=c5951e6c6fad5a9be897b57166a91a9f096ce6af0a0da724899f2b57a97006a6.css" />
<script defer type="text/javascript" src="../../js/main.js@h=e9256ad8bb73d1000c4167f68a3255ff61b7276031d009594ea6f4066e941fba"></script>

<script type="text/javascript" src="../../js/main-sync.js@h=a5a9607bf30db01764e4c92a4d4832318d20ec7d3ec29af4ddf72b7ddcb13817"></script>
<script>initDarkToggle();</script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.17.0/tocbot.min.js" integrity="sha512-DJhUMo5TIBb3fFziiE+3OJG+j7ky+GxScxHdLADCXskEpc/AKQsbsorIYmGFJFaJvDIyP65rJNhnCTytfYAdUw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark mb-4">
<div class="container">
<a class="navbar-brand" href="../../../index.html">
<img class="d-inline-block me-2 rounded" height="48" width="48" src="../../img/icon-small.png" alt="outline of square computer chip with cs61c label" />
<span class="align-middle">CS 61C Summer 2024</span>
</a>
<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle Navigation">
<span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="navbarContent">
<ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
<a class="nav-link" href="../../calendar/index.html">Calendar</a>
</li>
<li class="nav-item">
<a class="nav-link" href="../../staff/index.html">Staff</a>
</li>
<li class="nav-item">
<a class="nav-link" href="../../exam/index.html">Exam</a>
</li>
<li class="nav-item">
<a class="nav-link" href="../../policies/index.html">Policies</a>
</li>
<li class="nav-item">
<a class="nav-link" href="../../resources/index.html">Resources</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href="index.html#" id="navbarLinksDropdownToggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">Quick Links</a>
<ul class="dropdown-menu p-0" aria-labelledby="navbarLinksDropdownToggle">
<li><a class="dropdown-item nav-link" href="../../pdfs/resources/reference-card.pdf">Reference Card</a></li>
<li><a class="dropdown-item nav-link" href="https://oh.cs61c.org/">OH Queue</a></li>
<li><a class="dropdown-item nav-link" href="https://venus.cs61c.org/">Venus</a></li>
<li><a class="dropdown-item nav-link" href="https://inst.eecs.berkeley.edu/~cs61c/archives.html">Past Semesters</a></li>
</ul>
</li>
</ul>
</div>
</div>
</nav>
<main class="mb-4">
<section class="section">
<div class="container">
<div class="row spec">
<nav id="toc-wrapper" class="col-md-3 d-print-none sticky-md-top nav-wrapper" aria-label="table of contents">
<ul class="nav flex-column">
<li class="nav-item">
<a class="nav-link" href="index.html#setup">Setup</a>
</li>
<li class="nav-item">
<a class="nav-link" href="index.html#openmp">OpenMP</a>
</li>
<li class="nav-item">
<a class="nav-link" href="index.html#example-openmp-hello-world">Example: OpenMP Hello World</a>
</li>
<li class="nav-item">
<a class="nav-link" href="index.html#exercise-1-vector-addition">Exercise 1: Vector Addition</a>
</li>
<li class="nav-item">
<a class="nav-link" href="index.html#openmp-directives">OpenMP Directives</a>
<ul class="nav flex-column">
<li class="nav-item">
<a class="nav-link" href="index.html#for">For</a>
</li>
<li class="nav-item">
<a class="nav-link" href="index.html#critical">Critical</a>
</li>
<li class="nav-item">
<a class="nav-link" href="index.html#reduction">Reduction</a>
</li>
</ul>
</li>
<li class="nav-item">
<a class="nav-link" href="index.html#exercise-2-openmp-dot-product">Exercise 2: OpenMP Dot Product</a>
</li>
<li class="nav-item">
<a class="nav-link" href="index.html#submission">Submission</a>
</li>
</ul>
</nav>
<div id="toc-content-wrapper" class="content col-md-9">
<h1 class="title">Lab 8: TLP</h1>
<p class="subtitle">Deadline: Thursday, July 25, 11:59:59 PM PT</p>
<p><a href="https://docs.google.com/presentation/d/1ofYq_RH0wy2zT0WOIGBEir4aUKHmp7amwTHtOAtzhIA/view">Lab slides</a></p>
<h2 id="setup">Setup</h2>
<div class="alert alert-warning">
<p>You must complete this lab on the <strong>hive machines</strong> (not your local machine). See <a href="../lab00/index.html">Lab 0</a> if you need to set up the hive machines again.</p>
</div>
<p>In your <code>labs</code> directory on the hive machine, pull any changes you may have made in past labs:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">git</span></span><span class="z-meta z-function-call z-arguments z-shell"> pull origin main</span>
</span></code></pre>
<p>Still in your <code>labs</code> directory on the hive machine, pull the files for this lab with:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">git</span></span><span class="z-meta z-function-call z-arguments z-shell"> pull starter main</span>
</span></code></pre>
<p>If you run into any <code>git</code> errors, please check out the <a href="../../resources/common-errors/index.html">common errors</a> page.</p>
<h2 id="openmp">OpenMP</h2>
<p>OpenMP stands for <strong>O</strong>pen specification for <strong>M</strong>ulti-<strong>P</strong>rocessing. It is a framework that offers a C interface. It is not a built-in part of the C language -- most OpenMP features are compiler directives. (One example of a compiler directive you've seen in the past is <code>#include</code>.)</p>
<p>Benefits of multi-threaded programming using OpenMP include:</p>
<ul>
<li>A very simple interface that allows a programmer to separate a program into serial regions and parallel regions.</li>
<li>Convenient synchronization control (data race bugs in threads are very hard to trace).</li>
</ul>
<h2 id="example-openmp-hello-world">Example: OpenMP Hello World</h2>
<p>Consider the sample hello world program (<code>openmp_example.c</code>), which prints <code>&quot;hello world from thread #&quot;</code> from each thread:</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">main</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c"> </span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
<span class="z-meta z-preprocessor z-c">    <span class="z-keyword z-control z-import z-c">#pragma</span> omp parallel
</span>    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
        <span class="z-storage z-type z-c">int</span> thread_id <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">omp_get_thread_num</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
        <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">printf</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>hello world from thread <span class="z-constant z-other z-placeholder z-c">%d</span><span class="z-constant z-character z-escape z-c">\n</span><span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-separator z-c">,</span> thread_id</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p>This program will create a team of parallel threads. Each thread prints out a hello world message, along with its own thread number.</p>
<p>Let's break down the <code>#pragma omp parallel</code> line:</p>
<ul>
<li><code>#pragma</code> tells the compiler that the rest of the line is a directive.</li>
<li><code>omp</code> declares that the directive is for OpenMP.</li>
<li><code>parallel</code> says that the following block statement -- the part inside the curly braces (<code>{</code>/<code>}</code>) -- should be executed in parallel by different threads.</li>
</ul>
<p><strong>IMPORTANT:</strong> When writing your own code, ensure that you place the opening curly brace on a new line. Do not put it on the same line as the directive.</p>
<p>You can change the number of OpenMP threads by setting the environment variable <code>OMP_NUM_THREADS</code> or by using the <a href="https://gcc.gnu.org/onlinedocs/libgomp/omp_005fset_005fnum_005fthreads.html"><code>omp_set_num_threads</code></a> function before the parallel section in your program.</p>
<p>Try running the program:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">make</span></span><span class="z-meta z-function-call z-arguments z-shell"> openmp_example</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">./openmp_example</span></span>
</span></code></pre>
<p>If you run <code>./openmp_example</code> a couple of times, you may notice that the printed numbers are not always in increasing order and will most likely vary across runs. This is because we didn't specify any sort of synchronization options, so OpenMP will not enforce any execution order. (More on that later.) It is also important to note that the variable <code>thread_id</code> is defined inside the parallel block, which means that each thread has its own copy of <code>thread_id</code>. In general with OpenMP, variables declared inside the parallel block will be private to each thread, but variables declared outside a parallel block will be shared across all threads. There are ways to override this, but more on that later.</p>
<h2 id="exercise-1-vector-addition">Exercise 1: Vector Addition</h2>
<p>Vector addition is a naturally parallel computation, since it's an elementwise operation (element <code>i</code> of the result vector does not depend on elements <code>j != i</code>), so it makes for a good first exercise. The <code>v_add()</code> functions inside <code>ex1.c</code> will store the sum of input vectors <code>x</code> and <code>y</code> into the result vector <code>z</code>. A first attempt at this might look like:</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-type z-c">void</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">v_add</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">double</span><span class="z-keyword z-operator z-c">*</span> <span class="z-variable z-parameter z-c">x</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">double</span><span class="z-keyword z-operator z-c">*</span> <span class="z-variable z-parameter z-c">y</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">double</span><span class="z-keyword z-operator z-c">*</span> <span class="z-variable z-parameter z-c">z</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c"> </span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
<span class="z-meta z-preprocessor z-c">    <span class="z-keyword z-control z-import z-c">#pragma</span> omp parallel
</span>    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
        <span class="z-keyword z-control z-c">for</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-storage z-type z-c">int</span> i<span class="z-keyword z-operator z-assignment z-c">=</span><span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span> i<span class="z-keyword z-operator z-comparison z-c">&lt;</span>ARRAY_SIZE<span class="z-punctuation z-terminator z-c">;</span> i<span class="z-keyword z-operator z-arithmetic z-c">++</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
        <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
            z<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>i<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> x<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>i<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-arithmetic z-c">+</span> y<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>i<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span><span class="z-punctuation z-terminator z-c">;</span>
        <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p>Try running the tests:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">make</span></span><span class="z-meta z-function-call z-arguments z-shell"> ex1</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">./ex1</span></span>
</span></code></pre>
<p>The testing framework will time the function execution for different thread counts. You should observe that this implementation performs worse as we increase the number of threads! Why?</p>
<p>The issue is that each thread is executing all of the code within the <code>omp parallel</code> block. If we have 8 threads, we'll actually be performing the same vector addition 8 times! Not only that, but various threads writing to the same variables in memory may cause a decrease in performance due to cache synchronization. Rather than have each thread run every iteration of the <code>for</code> loop, we need to split the <code>for</code> loop iterations across all the threads so each thread does only a portion of the work.</p>
<p>OpenMP has built-in functionality for dividing up the work of <code>for</code> loops among threads. To tell openMP to split up the work among multiple threads, you would use <code>#pragma omp parallel for</code> as seen below:</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-type z-c">void</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">v_add</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">double</span><span class="z-keyword z-operator z-c">*</span> <span class="z-variable z-parameter z-c">x</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">double</span><span class="z-keyword z-operator z-c">*</span> <span class="z-variable z-parameter z-c">y</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">double</span><span class="z-keyword z-operator z-c">*</span> <span class="z-variable z-parameter z-c">z</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c"> </span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
<span class="z-meta z-preprocessor z-c">    <span class="z-keyword z-control z-import z-c">#pragma</span> omp parallel for
</span>    <span class="z-keyword z-control z-c">for</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-storage z-type z-c">int</span> i<span class="z-keyword z-operator z-assignment z-c">=</span><span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span> i<span class="z-keyword z-operator z-comparison z-c">&lt;</span>ARRAY_SIZE<span class="z-punctuation z-terminator z-c">;</span> i<span class="z-keyword z-operator z-arithmetic z-c">++</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
        z<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>i<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> x<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>i<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-arithmetic z-c">+</span> y<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>i<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p>Note that there are no opening and closing brackets around the parallel section. The <code>#pragma omp parallel for</code> directive can only be placed directly before a <code>for</code> loop.</p>
<p>There are two ways that you can split up work:</p>
<p><img src="vector_threads.png" alt /></p>
<ol>
<li><strong>Implement</strong> <code>v_add_optimized_adjacent()</code> in <code>ex1.c</code>, which separates the vectors into element-wise <strong>slices</strong>.
<ul>
<li>If we have 3 threads, thread 0 will handle all elements that are 0 modulo 3 (such as 0, 3, 6, etc), thread 1 will handle all elements that are 1 modulo 3 (such as 1, 4, 7, etc), and thread 2 will handle all elements that are 2 modulo 3 (such as 2, 5, 8, etc).</li>
</ul>
</li>
<li><strong>Implement</strong> <code>v_add_optimized_chunks()</code> in <code>ex1.c</code>, which separates the vectors into contiguous <strong>chunks</strong>.
<ul>
<li>If we have 3 threads, thread 0 will handle the first third of the elements in the array, thread 1 will handle the second third, and thread 2 will handle the last third. Remember to handle the tail case -- depending on your chunking logic, the last chunk may have slightly more or less elements than the others.</li>
</ul>
</li>
</ol>
<p>Your implementations should use the following 2 functions -- don't hard code thread counts or thread IDs:</p>
<ul>
<li><code>int omp_get_num_threads()</code> - returns the current <strong>total</strong> number of OpenMP threads. Note that the number of threads will be <code>1</code> outside of an OpenMP <code>parallel</code> section.</li>
<li><code>int omp_get_thread_num()</code> - returns the thread number of the current thread, commonly used as thread ID.</li>
</ul>
<p>For this exercise, you <strong>CANNOT</strong> use <code>#pragma omp parallel for</code>. You must manually split up the work of the threads.</p>
<p>Remember that speedup may not increase as much after a certain number of threads, since part of the program is not parallelizable.</p>
<h2 id="openmp-directives">OpenMP Directives</h2>
<p>Usage for OpenMP directives can be found <a href="https://inst.eecs.berkeley.edu/%7Ecs61c/sp21/resources-pdfs/OpenMP3.0-SummarySpec.pdf">on the OpenMP summary card</a>.</p>
<h3 id="for">For</h3>
<p>In exercise 1, you manually assigned iterations within a <code>for</code> loop to individual threads. OpenMP can take care of this automatically with the <code>for</code> directive! You can either add a <code>#pragma omp for</code> to an existing <code>for</code> loop within a <code>#pragma omp parallel</code>, or use <code>#pragma omp parallel for</code> by itself.</p>
<h3 id="critical">Critical</h3>
<p>The code in a critical section can only be executed by a single thread at any given time. Thus, having a critical section naturally prevents multiple threads from reading and writing to the same data, a problem that would otherwise lead to data races. OpenMP provides the <code>critical</code> primitive to allow you to perform computations within a critical section.</p>
<h3 id="reduction">Reduction</h3>
<p>Critical sections may be slow, so OpenMP has a built in way to reduce this problem through the use of the <code>reduction</code> keyword. The reduction keyword will increase the parallelizability of your code by automatically reducing the amount of code contained within the critical section. To use this keyword, you must specify the the variable that should be in a critical section and the operation being performed on that variable.</p>
<h2 id="exercise-2-openmp-dot-product">Exercise 2: OpenMP Dot Product</h2>
<p>At first glance, implementing a dot product might seem not too different from <code>v_add</code> from exercise 1, since we should now just perform elementwise multiplication instead of addition. The challenge is how to add the products into one variable (aka reduction) to get our final answer. If multiple threads try to add their results to the same variable at the same time, it will lead to a <strong>data race</strong> which will result in an incorrect result.</p>
<p>Try running the tests now, only the naive solution should pass since the other optimizations are not implemented.</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">make</span></span><span class="z-meta z-function-call z-arguments z-shell"> ex2</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">./ex2</span></span>
</span></code></pre>
<ol>
<li><strong>Implement</strong> <code>dotp_critical</code> using OpenMP and a critical section.
<ul>
<li>Notice how the performance gets much worse as the number of threads go up? By putting all of the work of reduction in a critical section, we have flattened the parallelism and made it so only one thread can do useful work at a time (not exactly the idea behind thread-level parallelism).</li>
<li>This contention is problematic; each thread is constantly fighting for the critical section and only one is making any progress at any given time. As the number of threads go up, so does the contention, and the performance pays the price.</li>
</ul>
</li>
<li><strong>Implement</strong> <code>dotp_reduction</code> using OpenMP and a reduction statement.
<ul>
<li>Hint: the variable that should only be accessed by one thread at a time is <code>global_sum</code> and the operation being performed on it is addition (<code>+</code>).</li>
</ul>
</li>
<li><strong>Implement</strong> <code>dotp_manual_reduction</code> using OpenMP and the idea of reduction, but do not use the <code>reduction</code> keyword.
<ul>
<li>Hint: create variables for each thread and only add to the final sum when absolutely necessary.</li>
</ul>
</li>
</ol>
<hr/>
<h2 id="submission">Submission</h2>
<p>Save, commit, and push your work, then submit to the <strong>Lab 8</strong> assignment on Gradescope.</p>
</div>
</div>
</div>
</section>
</main>
<footer>
<div class="container border-top pt-4 mb-5">
<div class="row">
<div class="col">
<div id="dark-toggle-wrapper" class="d-none">
<div class="form-check form-switch">
<input id="inputDarkToggle" class="form-check-input" type="checkbox">
<label class="form-check-label" for="inputDarkToggle">
Dark Mode
<a id="buttonDarkToggleReset" class="d-none" href="javascript:void(0);">(reset)</a>
</label>
</div>
</div>
</div>
</div>
</div>
</footer>
<script>
  

  
    document.addEventListener("DOMContentLoaded", function() {
      initToC();
    });
  
</script>
</body>
</html>
